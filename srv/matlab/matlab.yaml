apiVersion: v1
kind: PersistentVolume
metadata:
  name: matlab-root
spec:
  accessModes:
    - ReadOnlyMany
  capacity:
    storage: 10Gi
  cephfs:
    monitors:
      - "10.10.10.1:6789"
      - "10.10.10.5:6789"
      - "10.10.10.6:6789"
    path: /kubernetes/ifsc/sje/srv/matlab
    secretRef:
      name: ceph-secret
    user: admin
  storageClassName: matlab-root

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: matlab-home
spec:
  accessModes:
    - ReadWriteMany
  capacity:
    storage: 10Gi
  mountOptions:
    - nolock
    - nfsvers=3
  nfs:
    path: /nfs_kubernetes/kubernetes/ifsc/sje/a/home
    server: "191.36.8.71"
  storageClassName: matlab-home

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: matlab-servicos-etc
spec:
  accessModes:
    - ReadWriteMany
  capacity:
    storage: 100Mi
  cephfs:
    monitors:
      - "10.10.10.1:6789"
      - "10.10.10.5:6789"
      - "10.10.10.6:6789"
    path: /kubernetes/ifsc/sje/users
    secretRef:
      name: ceph-secret
    user: admin
  storageClassName: matlab-servicos-etc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: matlab-root
  name: matlab-root
  namespace: producao
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: matlab-root

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: matlab-home
  name: matlab-home
  namespace: producao
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: matlab-home

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: matlab-servicos-etc
  name: matlab-servicos-etc
  namespace: producao
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Mi
  storageClassName: matlab-servicos-etc

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: matlab
  name: matlab
  namespace: producao
spec:
  externalIPs:
    - "191.36.8.1"
    - "191.36.8.4"
    - "191.36.8.6"
    - "191.36.8.7"
    - "191.36.8.25"
  ports:
    - name: ssh
      port: 2222
      protocol: TCP
      targetPort: 22
  selector:
    app: matlab
  type: LoadBalancer

---
apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: matlab
  namespace: producao
spec:
  maxReplicas: 2
  metrics:
    - resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
      type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: matlab

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: matlab
  name: matlab
  namespace: producao
spec:
  selector:
    matchLabels:
      app: matlab
  template:
    metadata:
      labels:
        app: matlab
    spec:
      containers:
        - image: cticsjeifsc/matlab
          name: matlab
          ports:
            - containerPort: 22
              name: ssh
          resources:
            limits:
              cpu: 8
              memory: 12Gi
            requests:
              cpu: 4
              memory: 8Gi
          volumeMounts:
            - mountPath: /opt
              name: matlab-root
            - mountPath: /home
              name: matlab-home
            - mountPath: /mnt/shadow
              name: matlab-users
              subPath: shadow
            - mountPath: /mnt/passwd
              name: matlab-users
              subPath: passwd
            - mountPath: /mnt/group
              name: matlab-users
              subPath: group
            - mountPath: /mnt/cron_att_users.sh
              name: matlab-users
              subPath: cron_att_users.sh
            - mountPath: /etc/ldap.conf
              name: ldap-conf
              subPath: ldap.conf
            - mountPath: /etc/ldap/ldap.conf
              name: ldap-ldap-conf
              subPath: ldap.conf
            - mountPath: /etc/nsswitch.conf
              name: nsswitch-ldap-conf
              subPath: nsswitch.conf
            - mountPath: /etc/libnss-ldap.conf
              name: libnss-ldap-conf
              subPath: libnss-ldap.conf
            - mountPath: /etc/pam_ldap.conf
              name: pam-ldap-conf
              subPath: pam_ldap.conf
            - mountPath: /etc/pam.d/common-session
              name: pam-common-session
              subPath: common-session
            - mountPath: /root/.ssh/authorized_keys
              name: ssh-keys
              readOnly: true
              subPath: authorized_keys
      volumes:
        - name: matlab-root
          persistentVolumeClaim:
            claimName: matlab-root
        - name: matlab-home
          persistentVolumeClaim:
            claimName: matlab-home
        - name: matlab-users
          persistentVolumeClaim:
            claimName: matlab-servicos-etc
        - configMap:
            name: ldap-conf
          name: ldap-conf
        - configMap:
            name: ldap-ldap-conf
          name: ldap-ldap-conf
        - configMap:
            name: nsswitch-ldap-conf
          name: nsswitch-ldap-conf
        - configMap:
            name: pam-ldap-conf
          name: pam-ldap-conf
        - configMap:
            name: libnss-ldap-conf
          name: libnss-ldap-conf
        - configMap:
            name: pam-common-session
          name: pam-common-session
        - name: ssh-keys
          secret:
            secretName: authorized-keys-ctic
